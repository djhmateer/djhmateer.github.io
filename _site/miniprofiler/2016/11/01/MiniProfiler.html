<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Making applications faster using MiniProfiler</title>
  <meta name="description" content="Performance is an essential part of any business application. MiniProfiler is one of the tools I use to continually measure this. In fact over the last 2 yea...">

  
  
  <link rel="stylesheet" href="/css/main.css">

  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />

  <link rel="canonical" href="/miniprofiler/2016/11/01/MiniProfiler.html">
  <link rel="alternate" type="application/rss+xml" title="Dave Mateer&#39;s Blog" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    
    
    <a class="site-title" href="/">Dave Mateer&#39;s Blog</a>
    <!--<a class="site-title" href="">Dave Mateer&#39;s Blog</a>-->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          
          <a class="page-link" href="/about/">About</a>
          
          
        
          
          
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Making applications faster using MiniProfiler</h1>
    <p class="post-meta"><time datetime="2016-11-01T00:00:00+01:00" itemprop="datePublished">Nov 1, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Performance is an <strong>essential part of any business application</strong>. MiniProfiler is one of the tools I use to continually measure this. In fact over the last 2 years, <strong>every application</strong> I have written (and had to work on) has had MiniProfiler in it at some stage.</p>

<p>What is good performance? Ask the people who use your system.  In my experience users will tell you with <strong>brutal honesty</strong> what they think :-) There is a lot of <a href="http://stackoverflow.com/a/164290/26086">research</a> too.</p>

<h2 id="what-is-miniprofiler">What is MiniProfiler?</h2>
<ul>
  <li><a href="http://miniprofiler.com/">MiniProfiler</a> can show how long database queries take (commonly the bottleneck in my applications)</li>
  <li>Can show API calls, AJAX Calls, Controller and View render times</li>
  <li>ASP.NET MVC / Webforms</li>
  <li>Can be used in Development and Production (has good security)</li>
</ul>

<p><img src="/assets/MiniProfiler_1.jpg" alt="Cows" /></p>

<p>Miniprofiler <strong>overlays query times</strong> on any webpage. Here is a page showing 2 SQL queries which took 25.9ms to run.</p>

<h2 id="how-to-install-miniprofiler">How to install MiniProfiler</h2>
<p>Follow the instructions: <a href="http://miniprofiler.com/">here</a></p>

<ul>
  <li>Install the Nuget package MiniProfiler</li>
  <li>Put css and javascript references at top and bottom in \Views\Shared_Layout.cshtml</li>
  <li>Put a call in Global.asax.cs to start and end the profiler</li>
  <li>Add a line in the root web.config system.webServer handler</li>
</ul>

<h2 id="how-to-do-the-database-profiling-bit">How to do the database profiling bit</h2>
<p>I generally have a Util.cs class in my Service/DAL namspace:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="n">IDbConnection</span> <span class="nf">GetOpenConnection</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">connection</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SqlConnection</span><span class="p">(</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">ConnectionStrings</span><span class="p">[</span><span class="s">"ThinkBooksConnectionString"</span><span class="p">].</span><span class="n">ConnectionString</span><span class="p">);</span>
    <span class="n">connection</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
    <span class="n">MiniProfiler</span><span class="p">.</span><span class="n">Settings</span><span class="p">.</span><span class="n">SqlFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StackExchange</span><span class="p">.</span><span class="n">Profiling</span><span class="p">.</span><span class="n">SqlFormatters</span><span class="p">.</span><span class="nf">SqlServerFormatter</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ProfiledDbConnection</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">MiniProfiler</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>then</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">Util</span><span class="p">.</span><span class="nf">GetOpenConnection</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">db</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;(</span><span class="s">"SELECT TOP 10 * FROM Book"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Now let me show you the 5 things that I like about MP</p>

<h2 id="improving-query-times">1. Improving Query Times</h2>
<p>By far my biggest use of MiniProfiler is tuning SQL queries. Here is an example of a home page (always a good place to start looking at where to start optimising) query which took 160ms to run a search.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Author</span> 
<span class="k">WHERE</span> <span class="p">(</span><span class="o">@</span><span class="n">AuthorID</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">AuthorID</span> <span class="o">=</span> <span class="o">@</span><span class="n">AuthorID</span><span class="p">)</span>
<span class="k">AND</span> <span class="p">(</span><span class="o">@</span><span class="n">FirstName</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">FirstName</span> <span class="k">LIKE</span> <span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">FirstName</span><span class="p">,</span><span class="s1">'%'</span><span class="p">))</span>
<span class="k">AND</span> <span class="p">(</span><span class="o">@</span><span class="n">LastName</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">LastName</span> <span class="k">LIKE</span> <span class="s1">'%'</span> <span class="o">+</span> <span class="o">@</span><span class="n">LastName</span> <span class="o">+</span> <span class="s1">'%'</span><span class="p">)</span>
<span class="k">AND</span> <span class="p">(</span><span class="o">@</span><span class="n">DateOfBirth</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">DateOfBirth</span> <span class="o">=</span> <span class="o">@</span><span class="n">DateOfBirth</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">" + sanitizedSortColumn + "</span> <span class="nv">" + sortDirection + @"</span>
<span class="k">OFFSET</span> <span class="nv">" + offset + @"</span> <span class="k">ROWS</span> 
<span class="k">FETCH</span> <span class="k">NEXT</span> <span class="nv">" + numberOfResults + "</span> <span class="k">ROWS</span> <span class="k">ONLY</span><span class="nv">";</span></code></pre></figure>

<p>The business didn’t need lastname searching to be %lastname%, just lastname%, so after changing that:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">AND</span> <span class="p">(</span><span class="o">@</span><span class="n">LastName</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">LastName</span> <span class="k">LIKE</span> <span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">LastName</span><span class="p">,</span><span class="s1">'%'</span><span class="p">))</span></code></pre></figure>

<p>We can see the performance improvement immediately:</p>

<p><img src="/assets/MiniProfiler_2.jpg" alt="Cows" /></p>

<p>33ms query time now (from 160ms)</p>

<h2 id="duplicate-queries">2. Duplicate queries</h2>

<p><img src="/assets/MiniProfiler_3.jpg" alt="Cows" /></p>

<p>Another useful feature is highlighting if there are duplicate queries shown in red with a !</p>

<h2 id="seeing-where-orm-queries-need-to-be-replaced">3. Seeing where ORM queries need to be replaced</h2>
<p>I like Object Relational Mappers (ORMs) as they can save time writing boilerplace <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> SQL.  <a href="https://www.asp.net/entity-framework">Entity Framework</a> and <a href="https://github.com/StackExchange/dapper-dot-net/tree/master/Dapper.Contrib">Dapper.Contrib</a> are what I have most recently used.</p>

<p>For high performance screens (typically home screens, summary views of large datasets) it can be writing an abstraction on top of an abstraction.. why optimise LINQ when SQL gives you much more control?</p>

<p><a href="https://github.com/StackExchange/dapper-dot-net">Dapper</a> is very close to raw ADO, and I generally use that for high performance screens. It gives the safety of a good mapper with performance.</p>

<p>Here is a screen where using an ORM is <strong>asking for trouble</strong></p>

<p><img src="/assets/MiniProfiler_5.jpg" alt="Cows" /></p>

<p>Filtering, Sorting and Paging. Also returning a count of total records.  Difficult to get right in an ORM, and fine in SQL.  Very fast performance (18ms).</p>

<h2 id="n1">4. N+1</h2>
<p>If you have 50 Authors on the screen, and each has an AuthorStatusID which is Foreign Key’d to an AuthorStatus table:</p>

<p><img src="/assets/MiniProfiler_8.jpg" alt="Cows" /></p>

<p>I have 50 Authors on the screen, and MiniProfiler is showing 52 queries, and showing as Duplicate queries.  A huge red flag :-)</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// Horrible way of getting the AuthorStatus eg Alive or Dead
</span><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">author</span> <span class="k">in</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">authorStatusName</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">"SELECT Name from AuthorStatus WHERE AuthorStatusID = @AuthorStatusID"</span><span class="p">,</span>
        <span class="k">new</span> <span class="p">{</span> <span class="n">author</span><span class="p">.</span><span class="n">AuthorStatusID</span> <span class="p">}).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
    <span class="n">author</span><span class="p">.</span><span class="n">AuthorStatusName</span> <span class="p">=</span> <span class="n">authorStatusName</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Lets get the database to do the hard work:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="err">@</span><span class="s">"
</span>        <span class="n">SELECT</span> <span class="n">a</span><span class="p">.*,</span> <span class="n">s</span><span class="p">.</span><span class="n">Name</span> <span class="n">AS</span> <span class="n">AuthorStatusName</span> <span class="n">FROM</span> <span class="n">Author</span> <span class="n">a</span>
        <span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">AuthorStatus</span> <span class="n">s</span> <span class="n">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">AuthorStatusID</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">AuthorStatusID</span>
        <span class="nf">WHERE</span> <span class="p">(</span><span class="n">@AuthorID</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">OR</span> <span class="n">AuthorID</span> <span class="p">=</span> <span class="n">@AuthorID</span><span class="p">)</span>
        <span class="nf">AND</span> <span class="p">(</span><span class="n">@FirstName</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">OR</span> <span class="n">FirstName</span> <span class="n">LIKE</span> <span class="nf">CONCAT</span><span class="p">(</span><span class="n">@FirstName</span><span class="p">,</span><span class="sc">'%'</span><span class="p">))</span>
        <span class="nf">AND</span> <span class="p">(</span><span class="n">@LastName</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">OR</span> <span class="n">LastName</span> <span class="n">LIKE</span> <span class="nf">CONCAT</span><span class="p">(</span><span class="n">@LastName</span><span class="p">,</span><span class="sc">'%'</span><span class="p">))</span>
        <span class="nf">AND</span> <span class="p">(</span><span class="n">@DateOfBirth</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">OR</span> <span class="n">DateOfBirth</span> <span class="p">=</span> <span class="n">@DateOfBirth</span><span class="p">)</span>
        <span class="n">ORDER</span> <span class="n">BY</span> <span class="s">" + sanitizedSortColumn + "</span> <span class="s">" + sortDirection + @"</span>
        <span class="n">OFFSET</span> <span class="s">" + offset + @"</span> <span class="n">ROWS</span> 
        <span class="n">FETCH</span> <span class="n">NEXT</span> <span class="s">" + numberOfResults + "</span> <span class="n">ROWS</span> <span class="n">ONLY</span><span class="err">"</span><span class="p">;</span></code></pre></figure>

<p><img src="/assets/MiniProfiler_9.jpg" alt="Cows" /></p>

<p>380ms to 9ms - much much faster!  The other 2 times are browserlink javascript calls from visual studio.</p>

<h2 id="api-calls">5. API calls</h2>
<p><img src="/assets/MiniProfiler_6.jpg" alt="Cows" /></p>

<p>A project of mine which does many calls to the Spotify API.  On this page there were 6 API calls, and 1 SQL call.  MiniProfiler was very useful in highlighting <strong>which API calls were taking the most time</strong>  Interestingly I found issues with Azure’s DNS, which meant it was much faster to run on EC2 for a while (was a geolocation lookup issue). Also I found doing API calls in parallel worked well for Spotify (whose response times are fantastic).</p>

<p>live site <a href="http://www.davestopmusic.com/Artists/Details/12Chz98pHFMPJEknJQMWvI">DavesTopMusic</a></p>

<h2 id="controller-and-view-profiling">6. Controller and View Profiling</h2>
<p>A little bit more information can be had on controller and view instrumentation <a href="http://stackoverflow.com/a/31568406/26086">here</a></p>

<h2 id="conclusion">Conclusion</h2>
<p>Performance is an <strong>essential part of any business application</strong>, and a <a href="https://blog.codinghorror.com/performance-is-a-feature/">Feature</a></p>

<p>I use <a href="http://miniprofiler.com/">MiniProfiler</a> to quantify performance.
<br />
<br />
<br />
<br />
<br />
<br />
<br /></p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <!--<h2 class="footer-heading">Dave Mateer&#39;s Blog</h2>-->

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            <!--
              Dave Mateer&#39;s Blog
            -->
            <img src="/assets/DaveMateer.jpg" />
            </li>
            <li>            
            Dave is a senior developer for <a href="www.qnrl.com">qnrl.com</a>, conference speaker, dad, rock climber, (average) guitar player, ex oil rig worker, ex outdoor instructor, bad joke teller and lover of technology
            </li>
        
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/djhmateer"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">djhmateer</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/dave_mateer"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">dave_mateer</span></a>

          </li>
          

            <li><a href="mailto:davemateer@gmail.com">davemateer@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>In depth articles on software production
</p>
        <p>rev: 2016-11-15 15:26:33 GMT</p>
      </div>
    </div>

  </div>
</footer>


  </body>

</html>

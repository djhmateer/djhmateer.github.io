---
layout: post
title: xunit testing complex objects 
description: 
menu: review
categories: xunit 
published: false 
comments: false     
sitemap: false
image: /assets/2020-02-03/40.jpg
---

<!-- ![alt text](/assets/2020-02-03/41.jpg "Choosing an image"){:width="600px"} -->

## Setting up a Integration Tests project for Web App

Add new project, xunit.

Add nuget package: `Microsoft.AspNetCore.Mvc.Testing` then update the other nuget packages too.

In the `.csproj` file change build to .Web

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">
  <PropertyGroup>
    <TargetFramework>netcoreapp3.1</TargetFramework>
    <IsPackable>false</IsPackable>
  </PropertyGroup>
```

To disable shadowcopying which stops tests executing in a different directory from the build output. As we need the appsettings.json file to be palces alongside th e dll for db connection string.

`xunit.runner.json` add in and

```json
{
	"shadowCopy": false
}
```

## Healthcheck page

From the standard Razor pages web project (.NET Core 3.1)

[MS Docs](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-3.1)

[Hanselman article](https://www.hanselman.com/blog/HowToSetUpASPNETCore22HealthChecksWithBeatPulsesAspNetCoreDiagnosticsHealthChecks.aspx)

```cs
// startup.cs
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services.AddHealthChecks();
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // ...
    app.UseEndpoints(endpoints =>
    {
        endpoints.MapHealthChecks("/healthcheck");
        // ...
    });

```

## Make a test

Make a HealthCheckTests.cs page

```cs
// IClassFixture is a Generic interface which expects a class type which will act as a fixture
// WebApplicationFactory is the type - which is in AspNetCore.Mvc.Testing
// Startup is the entry point for the service under test

public class HealthCheckTests : IClassFixture<WebApplicationFactory<Startup>>
{
    private readonly HttpClient _httpClient;

    public HealthCheckTests(WebApplicationFactory<Startup> factory)
    {
        // create a client that we can use to send a request to the test server
        _httpClient = factory.CreateDefaultClient();
    }

    [Fact]
    public async Task HealthCheck_ReturnsOk()
    {
        var response = await _httpClient.GetAsync("/healthcheck");

        Assert.Equal(HttpStatusCode.OK, response.StatusCode);
    }
}

```

and run it from VS, R# or the CLI:

```bash

dotnet test -c Release

```

### ClassFixture

> An [xUnit feature](https://xunit.net/docs/shared-context) used to create, setup and teardown a shared test class instance, used across all test methods defined in the test class

So starting up the test server is only done once. So this is faster.

## WebApplicationFactory

[Andrew Locke](https://andrewlock.net/converting-integration-tests-to-net-core-3/). Asp.NET Core includes`Microsoft.AspNetCore.TestHost' which contains an in-memory web host that doesn't use the networking layer.




https://andrewlock.net/creating-parameterised-tests-in-xunit-with-inlinedata-classdata-and-memberdata/


https://andrewlock.net/creating-strongly-typed-xunit-theory-test-data-with-theorydata/#using-theorydata-with-the-classdata-attribute

Crawler12 tests I've implemented it

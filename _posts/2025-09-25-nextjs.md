---
layout: post
title: 
description: 
menu: review
categories: nextjs 
published: true 
comments: false     
sitemap: false
image: /assets/2024-05-03/4.jpg
---

<!-- [![alt text](/assets/2025-08-30/6.jpg "Volcano")](/assets/2025-08-30/6.jpg) -->


> Use Next.js like it's PHP/Rails but with React when you need it

- Next.js (App Router)
- Shadcn/ui and Tailwind
- Drizzle
- Postgres

Perhaps

- Lucia or NextAuth or Auth.js - for auth
- Railway/Render - VM for background jobs, websockets, and solid logging, and cost savings


## Bar

I'm building a greenfield app in 2025. I will probably need React on the frontend for some parts of the app to do complex forms and to use the design system shadcn/ui. Other parts of the system are simple CRUD and don't need react. I'd like to host on a VM and have a database. What are my options?

what about other design systems that aren't shadcn/ui?

## Foo

[https://chatgpt.com/share/68d54d0f-0080-8006-a294-650b0b1e9c00](https://chatgpt.com/share/68d54d0f-0080-8006-a294-650b0b1e9c00)

`In next.js or astro, when should one use React and when should one use a server based data fetching / html generational model?

I've used server side frameworks for years such as asp.net, php, ruby on rails. Hosted on a single VM with a separate DB, they can handle huge loads and are easy to debug.

With the advent of react and client side framworks which make javascript interacticity easy they are very commong. 

Firstly why should one use React? What are they parts of a CRUD based application that it shines in?`


### When React is the right tool

React shines anywhere your UI has long-lived client state or rich interactions that would be clumsy as full page reloads.

Sweet spots in CRUD apps

- **Inline editing & optimistic UI** Editable tables, drag-to-reorder, multi-select with bulk actions, undo/snackbar flows.

- **Complex forms**. Conditional fields, debounced validation, nested arrays (e.g., invoices with line items), rich editors, wizards.

- **Realtime views**. Presence indicators, live counters, notifications, collaborative cursors; WebSocket/SSE hooks.

- Reusable design systems. Where a component library and composition pay off across the app.

If a screen is mostly read → click → navigate, React is often overkill.


## How to use Next.js 

If we need React (and I'd argue it is necessary for most modern day apps)

[https://chatgpt.com/share/68d62c71-f5ac-8006-b689-5bf33bfcd055](https://chatgpt.com/share/68d62c71-f5ac-8006-b689-5bf33bfcd055)

For small teams lets flatten the stack:

- Server-first to prevent edge cases, cache revalidation, hydration drift
- VM hosting allows simple logs
- Keep client JS minimal and intentional

## Minimal Next.js stack

As with other stacks where I've been frustrated by complexity (well, frustrated by my own lack of knowledge usually!), lets take the good parts of Next.js and make a great simple stack.

With .NET I found an incredible sweet spot which made developing apps a breeze. I wrote a massive blog post series, and understood the stack well.

- No caching
- No massive ORM (Entity Framework!) but favour simplicity like Dapper
- Migrations I didn't even use
- Keep layers of abstration as simple as possible ie usually only 1 db.cs import (along with global auth)
- Self host so I can reliably deploy (with a bash script to build) and have massive performance.

So with Next.js I wonder

- Server Side Rendering 
- No caching
- Self host on raw VM - just use nginx and node (using pnpm)..systemd.. zero downtime deploy with sym link so can revert.
- Postgres
- Shadcn/ui for pre-built great looking components
- 



## Self Host

[https://nextjs.org/docs/app/getting-started/deploying](https://nextjs.org/docs/app/getting-started/deploying)






[https://medium.com/upcloud/how-to-deploy-next-js-to-cloud-servers-a-step-by-step-guide-bb078bfff6f4](https://medium.com/upcloud/how-to-deploy-next-js-to-cloud-servers-a-step-by-step-guide-bb078bfff6f4)

In the spirit of just code.. and get something working..

- Create a self hosted VM
- bash script to install everything needed for Next.js 
- run a deployment straight to the Next.js server (no nginx yet)

```bash
# Node Version Manager - nvm

# https://github.com/nvm-sh/nvm
# check the version number and put below. This is an update script as well
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash

# restart shell or 
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion


# 0.40.3 on 29th Sept 25
nvm -v

## node 22.20.0 on 29th Sept 25
nvm install --lts

# 10.9.3
npm -v

# update npm.. now 11.6.1 on 29th Sept 25
npm install -g npm

# 10.17.1
npm install -g pnpm


cd /var/www
git clone 

# pnpm install
pnpm i

# pnpm update
# update all packages to latest..hmm react-dom from 19.1.0 to 19.1.1
pnpm up --latest

# Nginx
sudo apt-get install nginx -y

# service
mkdir /srv/

sudo git clone https://github.com/djhmateer/minimal-nextjs.git

## chown to a deploy user?

sudo chown -R www-data:www-data /srv/minimal-nextjs

# sudo chmod +x /srv/minimal-nextjs/
sudo chmod 777 /srv/minimal-nextjs/

pnpm run build


# for if git folder has a different owner ie www-root
sudo git config --global --add safe.directory /srv/minimal-nextjs

# nginx is on my reverse proxy
#sudo cp /srv/minimal-nextjs/infra/nginx.conf /etc/nginx/sites-available/default

# test the config
# sudo nginx -t

# sudo nginx -s reload

# systemd or pm2

# manual testing - run the next start server as defined in package.json
pnpm -- start

# test process is running
curl -I http://127.0.0.1:3000

```

then following the [automated installation](https://nextjs.org/docs/app/getting-started/installation)

```bash

# 15.5.4 on 29th Sept 25
pnpx create-next-app@latest minimal-nextjs --ts --eslint --tailwind --no-src-dir --app --turbopack --no-import-alias --use-pnpm

cd minimal-nextjs

# post install scripts
# tailwindcss_oxide
# unrs-resolver
# sharp
pnpm approve-builds

# http://localhost:3000/
pnpm run dev
```

###  Testing locally

I don't have any domain names at the moment, so lets just hit the webserver locally by ip

pfsense2 is on 192.168.1.179
:8080 is pfsense

:80 is just the default reverse proxy ie pfsense forwards to 172.16.44.104 (NGINX-RP)

how about pfsense redirects port 81 to 172.16.44.130:3000

http://192.168.1.179:81/


[![alt text](/assets/2025-09-30/1.jpg "Sample page")](/assets/2025-09-30/1.jpg)

A production build of a sample next.js project.

js is cached well in browser

I changed a file to Dave2 in source, then on the sever

```bash
# 9 seconds to lint, build and start on desktop and server
pnpm build
pnpm start
pnpm lint 
```

### Node.js

When run `pnpm run build` it runs `next build` which

- Transpiles TS/JSX
- Bundles client-side assets
- Prepared .next/ directory with optimised output
- Runs static optimisation and prerenders any SSG pages
- Prepares server code for SSR routes

`pnpm start` 

- Runs `next start` - next.js's minimal Node server that uses build output in `.next/`. Internally known as `NextNodeServer`
- serves prebuilt static assets
- handes SSR (Server Side Rendering)
- provides routing based on the filesystem and middleware


### Filesystem

I got Turbopack’s filesystem benchmark of 136ms warning. The disk iops on my hypervisor were going hard with other work. ZFS on RAID1. 

todo - boot my filesystem


### Middleware for logging

I like to see everything on the server

```ts
import { NextResponse } from 'next/server'

export function middleware(request) {
  const start = Date.now()

  const response = NextResponse.next()
  const duration = Date.now() - start

  console.log(`${new Date().toISOString()} - ${request.method} ${request.nextUrl.pathname} - ${duration}ms`)

  response.headers.set('x-response-time', `${duration}ms`)

  return response
}

// defines which paths will invoke the middleware
//   - /(...) - Match paths starting with /
//   - (?!_next/static|_next/image|favicon.ico) - Negative lookahead: Don't match these patterns
// also svgs
//   - .* - Match everything else
export const config = {
  matcher: '/((?!_next/static|_next/image|favicon.ico|.*\\.svg).*)',
}
```
and 

```bash
#!/bin/bash

echo "Step 1: Pulling latest changes..."
git pull

echo "Step 2: Building application..."
step_start=$(date +%s)
pnpm build
step_end=$(date +%s)
echo "Build completed in $((step_end - step_start)) seconds"

echo "Step 3: Starting application..."

# Have got middleware.js for logging on prod
pnpm start

# noisy
# DEBUG=next:* pnpm start

# still noisy
# DEBUG=next:router-server:main pnpm start
```
and now we have logging.. can't get response code due to limitaion on middleware logging. [https://news.ycombinator.com/item?id=45099922](https://news.ycombinator.com/item?id=45099922)

I'll be logging via nginx in prod.

## SSR (Server Side Rendering)

SSG - Server Side Generated (ie 'static' and not good for db calls)

```ts
// app/page.tsx

export const dynamic = 'force-static'

const Homepage = () => {
  const currentTime = new Date().toLocaleString();

  return (
    <div className="p-4">
      <h1 className="text-2xl mb-4">Home</h1>
      <p>this data is the next.js default of statically generated on the server - Server Side Generated. Build time: {currentTime}</p>
    </div>
  );
};

export default Homepage;
```

SSR - Server Side Rendered.. async by convention. 

```ts
// app/about/page.tsx

export const dynamic = 'force-dynamic';

// note async!
const AboutPage = async () => {
  const currentTime = new Date().toLocaleString();
    
  return (
    <div className="p-4">
      <h1 className="text-2xl mb-4">About</h1>
      <p>build time is (ie page data is Server Side Rendered on each request {currentTime}</p>
    </div>
  );
};

export default AboutPage;
```

[![alt text](/assets/2025-09-30/2.jpg "Dynamic")](/assets/2025-09-30/2.jpg)

`pnpm build` output shows which routes are dynamic and which are static.


## Server and Client Components

By default layouts and pages are Server Components.

Server vs Client Components is determined by "use client" directive
    - No "use client" = Server Component (your case)
    - Has "use client" = Client Component
    
export const dynamic controls when/how the component renders on the server:
    - 'force-static' = Pre-rendered at build time (SSG)
    - 'force-dynamic' = Rendered on each request (SSR)
    - 'auto' = Next.js decides


When you navigate between routes, Next.js unmounts the current page component, an mounts the new one.  So that is why the state returns to 0 after clicking away.

Could use localStorage, or state in the layout component as this stays mounted.

[![alt text](/assets/2025-09-30/3.jpg "minimaljs")](/assets/2025-09-30/3.jpg)

`minimal-nextjs` shows a good flow of understanding concepts. Having a production server vm is invaluable

## Params

Param ie /users/1

[![alt text](/assets/2025-09-30/4.jpg "prefetch")](/assets/2025-09-30/4.jpg)

To stop prefetch when I'm on /users/2 I set all links to `prefetch={false}`


## Custom 404

not-found.tsx

## Loading State

loading.tsx

The loading.tsx file only appears when Next.js is **waiting for the Server Component to finish rendering**... so it doesn't work when waiting for data over the wire?

It is a client component, so will be cached on the client. 

I have seen it fail for no apparent reason.

I've got a global loading.tsx page which I testing.

## DB

spin up postgres on dev and live server.

18 is most recent on 25th Sept 2025 [https://www.postgresql.org/download/linux/ubuntu/](https://www.postgresql.org/download/linux/ubuntu/)

```bash
# postgressql16 on 1st Oct 2025 on standard repo.
# -contrib is extra utilities like uuid-ossp
# libpq-dev is client lib dev package.. do I need? eg python/ruby

# sudo apt install postgresql postgresql-contrib libpq-dev
sudo apt install postgresql postgresql-contrib 

# 16.10 on 1st Oct 2025
psql --version

## prefer systemctl as service is just a thin wrapper on top
# on systemctl (service is maintained for backwards compatibility)
sudo systemctl enable postgresql
sudo systemctl start postgresql
sudo systemctl restart postgresql
sudo systemctl status postgresql

# previous service
# sudo service postgresql start
#sudo service postgresql restart
# sudo service postgresql status

# create a user
sudo -i -u postgres
psql
CREATE ROLE bob WITH LOGIN PASSWORD 'password' SUPERUSER;

# show all roles (users)
\du

\q
# Peer authenticaion failed for user bob
PGPASSWORD='password' psql -U bob -d postgres 

# Lets switch to password auth on local connections
sudo vim /etc/postgresql/16/main/pg_hba.conf

# top line from peer to scram-sha-256 so I can connect from wsl2
local   all     all   scram-sha-256
# add at bottom of pg_hba.conf so I can connect from windows
host    all   all 0.0.0.0/0    md5

# change in postgresql.conf so I can connect from windows
sudo vim /etc/postgresql/16/main/postgresql.conf
listen_addresses = '*'

sudo systemctl restart postgresql

PGPASSWORD='password' psql -U bob -d postgres 
psql -U bob -d postgres 

# list dbs
\l
CREATE DATABASE test;

# 172.31.112.181 laptop, 172.23.16.249 desktop (both wsl instances)
# I've disabled my Ubuntu22 instance
hostname -I

# connect to db test
\c test

# test the connection
#psql postgresql://bob:password@localhost:5432/test

# show tables in public schema
\dt 

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

```

for dev

```bash
# nice shortcut

# vim ~/.bashrc
export PGUSER=dave
export PGDATABASE=postgres

source ~/.bashrc

ALTER USER bob WITH PASSWORD 'password';
```


[![alt text](/assets/2025-09-30/5.jpg "connect")](/assets/2025-09-30/5.jpg)

So this is it working on 5433 from Windows to WSL2 (where there is another WSL2 instance running postgres on 5432)

[![alt text](/assets/2025-09-30/6.jpg "all dbs")](/assets/2025-09-30/6.jpg)

Remember to Show all databases.

## Connect to DB from Next.js

db name is: minimal_nextjs (use underscores and not dashes)


```sql
CREATE TABLE public.users (
	id int GENERATED ALWAYS AS IDENTITY NOT NULL,
	"name" varchar NOT NULL
);

INSERT INTO public.users ("name")
VALUES
  ('Alice'),
  ('Bob'),
  ('Charlie'),
  ('Diana'),
  ('Ethan');

select * from users
```


[![alt text](/assets/2025-09-30/6.jpg "all dbs")](/assets/2025-09-30/6.jpg)

![alt text](image-1.png)

Installing vim keyboard bindings into eclipse

http://vrapper.sourceforge.net/update-site/stable

[https://github.com/vrapper/vrapper](https://github.com/vrapper/vrapper)


### DB Success

![alt text](image-3.png)
Database connection working on live and on dev




## Foo
do a super time sql connection to it
head towards shadcn/ui components

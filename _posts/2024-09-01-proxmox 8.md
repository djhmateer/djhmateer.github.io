---
layout: post
# title: LLM Run Locally with CPU and Text Generation WebUI 
description: 
menu: review
categories: proxmox 
published: true 
comments: false     
sitemap: false
image: /assets/2024-05-03/4.jpg
---

I've been running Proxmox 7 in production for the last 2.5 years. It's been sitting in my home on a small PC (Silver) connected straight to the router and has been incredably useful. 

- started with [bare metal](https://davemateer.com/2022/01/12/home-web-server)
- moved to [Proxmox 7 beginners guide](https://davemateer.com/2022/01/12/home-web-server)

## Lessons Learned

- SSD's fail. 
- Hardware fails.
- Standard routers are fickle (DHCP leases sometimes get confused)
- Electricity cuts do happen (PM did recover fine)
- I want a backup PM server ready to go (and a testing server as well)
- You always need more disk space than you think on a VM
- Home connection with dynamic DNS has been great. Was 48Mbps down and 12MMbps up. Now on fibre at 500/110.
- Backups are super important
- Template VM's useful for spinning up test VM's quickly
- pfSense is hard
- System has been very reliable
- Been invaluable for archiving as many services now (eg YouTube) will block cloud based IP's

## Servers Setup

[![alt text](/assets/2024-09-17/1.jpg "email"){:width="500px"}](/assets/2024-09-17/1.jpg)

BIOS settings for my silver server (which had SSD and potential hardware failture). Notice auto power on.

## Router Setup

[![alt text](/assets/2024-09-17/2.jpg "email"){:width="700px"}](/assets/2024-09-17/2.jpg)

- [http://192.168.1.254/](http://192.168.1.254/) Router Admin

Router thinks that .139 is not connected (but it is as the PM Admin interface answers). 1 port having 2 IP addresses is confusing the GUI for the router. 

There are 2 .139 addresses as the MAC address changed when I got the backup PM server. 

(Static) means the local IP address is assigned by the device. It was initially assigned DHCP when Proxmox was installing, now it is fixed. Interestinly I can't change the router to 'always use this IP address' as it isn't assigned by DHCP anymore. I hope DHCP wont assign .88 anymore.

I did deleted some entries which were not used anymore, and the router did some strange things like being extremely slow (and management interface loading slowly) and needed a boot. 

[![alt text](/assets/2024-09-17/3.jpg "email"){:width="700px"}](/assets/2024-09-17/3.jpg)

All 80 and 443 traffic is forwarded to pfsense on 192.168.1.144 (whc)

- [https://192.168.1.139:8006/](https://192.168.1.139:8006/) PM Admin interface
- [https://192.168.1.144:8080/](https://192.168.1.144:8080/) Pfsense Admin interface

This router can assign 64 IP addresses on DHCP


## Proxmox 8 Server Build (PVE2)

I've got new hardware and want to bring this server up at the same as as the original so need new IP addresses (which will become static)

Use balenaetcher to create a USB bootable disk

### Boot disks RAID1 - Mirror

[![alt text](/assets/2024-09-17/4.jpg "email"){:width="500px"}](/assets/2024-09-17/4.jpg)

RAID1 (Mirror) on m.2 disks

[https://www.youtube.com/watch?v=lhRPhBDysVI](https://www.youtube.com/watch?v=lhRPhBDysVI)

Going to separate out boot drive from data. So that if data drives fail I can boot.

```bash
# can see any errors
# zfs pool is called: rpool
zpool status
```

### Networking

- Hostname FQDN - pve2.dave.home
- IP - 192.168.1.88  (was assigned by DHCP)
- Gateway - 192.168.1.254 (the router)
- DNS - 192.168.1.254 (the router)

DHCP range is .64 to .253

[https://192.168.1.88:8006](https://192.168.1.88:8006) - PM admin interface

### Updates

Disable Enterprise repos

Add no subscription repos

[![alt text](/assets/2024-09-17/5.jpg "email")](/assets/2024-09-17/5.jpg)

PVE 8.2.4 running and updated on new hardware.

## Data Disks - RAIDZ-1 - ZFS Datapool

I've got 4 data disks which I want to be running for resilience.

RAIDZ-1 (tolerates 1 drive loss) which needs at least 3 disks

I don't need anything special (just want redundancy but not overly) so lets use RAIDZ-1

[![alt text](/assets/2024-09-17/6.jpg "email")](/assets/2024-09-17/6.jpg)

pve2, disks, zfs, create ZFS

- datapool -  (tank is common name)
- compression on (saves on writes, and cpu is cheap)
- ashift - 12 (default)

```bash
zpool status
zfs list
```

## Datadirectory on ZFS Datapool

[![alt text](/assets/2024-09-17/9.jpg "email")](/assets/2024-09-17/9.jpg)

DataDirectory

Now I can upload an ISO

[Ubuntu 24.04.1 LTS](https://ubuntu.com/download/server)

[Ubuntu 22.04.5]() - my current standard build.


## Create a VM

[https://www.youtube.com/watch?v=sZcOlW-DwrU](https://www.youtube.com/watch?v=sZcOlW-DwrU) craft computing pm 8 - very good explanations as to what the different settings are.


[![alt text](/assets/2024-09-17/10.jpg "email")](/assets/2024-09-17/10.jpg)

BIOS

[![alt text](/assets/2024-09-17/11.jpg "email")](/assets/2024-09-17/11.jpg)

disks - give 80GB - on ZFS created with thin provisioning, so it only uses whats needed

[![alt text](/assets/2024-09-17/12.jpg "email")](/assets/2024-09-17/12.jpg)

max performance of the VM. Min of 4 threads/cores. I have 28 cores in 1 socket.


[![alt text](/assets/2024-09-17/13.jpg "email")](/assets/2024-09-17/13.jpg)

memory max - give 4GB at least only uses what needed (ballooning)

[![alt text](/assets/2024-09-17/14.jpg "email")](/assets/2024-09-17/14.jpg)

and

[![alt text](/assets/2024-09-17/15.jpg "email")](/assets/2024-09-17/15.jpg)

Start up the VM. It got an IP from the DHCP server of 192.168.1.251, and as I installed SSH I can just use my terminal to connect

```bash
# so pm can see the IP address
sudo apt install qemu-guest-agent
```

## Firewall and DHCP Networking

I want to run multiple websites inside PM. I used to run pfSense for firewalls and internal DHCP.

Is it possible to use just the proxmox firewall and router DHCP?

[video](https://www.youtube.com/watch?v=GiOjFJGGzuw&t=8s)

```bash
# if you get locked out type this into hard wired terminal
pve-firewall stop
```

/etx/pve/firewall/cluster.fw - can enable or disable here.

Datacenter, Firewall

- turn on (be careful)
- in, ACCEPT, tcp, 22, source: my machines, (ssh)
- in, ACCEPT, tcp, 8006 (management)
- in, ACCEPT, interface: imbr0, icmp (ping)
- in, DROP

pve (host), Firewall

- in, DROP, tcp, port 22

container/vm, Firewall

- turn on
- ACCEPT, tcp, 80
- ACCEPT, tcp, 22, source: my machine (ssh)

## Backups


## Create a Template?

Make sure SSH is installed (with a key?)

**TODO

Goal: Get all the VM's running well.








## Bridge

vmbr0





## Foo

zfs get atime
zfs set atime=off $POOLNAME


- reduce the amount of writes to a SSD
atime


- Server is set to auto power on (in bios) in event of power cycle 
- Router forwards port 80 and 443 (and sometimes port 22) to pfSense
- [pfsense](https://www.pfsense.org/) for NAT and Firewall
- Nginx reverse proxy forwards web traffic to appropriate internal website VMs
- Access point for admin while I'm away is an Ubuntu VM with SSH keys and [fail2ban](https://github.com/fail2ban/fail2ban) and [here](/2022/07/29/proxmox#secure-ssh-remote-access---part-5)

I can connect to any VM via my WSL2

```bash
# have mapped different ports to different internal machines
ssh pfsense -p 39
```







## VM Websites / APIs

[http://mateer.hopto.org/](http://mateer.hopto.org/) is the name I got from [https://www.noip.com/](https://www.noip.com/) which my router talks to to provide dynamic DNS.

I've got an Nginx reverse proxy in front of all websites which forwards traffic to a specific internal IP via http. It also handles certificates via [certbot](/2023/10/12/certbot-on-nginx-reverse-proxy)

- [hoverflylagoons.co.uk](https://hoverflylagoons.co.uk/) - Apache / PHP . MySQL - 2GB
- [theskatefarmcic.co.uk](https://theskatefarmcic.co.uk/) - Apache / PHP / MySQL - 2GB
- API that runs a hatespeech AI called from [https://osr4rightstools.org/](https://osr4rightstools.org/)
- website that runs firemap called from 

Maybe move over

- [https://osr4rightstools.org/](https://osr4rightstools.org/) - .NET 1GB RAM. **todo** - certbot for certs
- [https://auto-archiver.com/](https://auto-archiver.com/) - .NET 1GB RAM **todo** certbot for certs
- [https://arlawesi.org.uk/](https://arlawesi.org.uk/) - .NET 1GB RAM **todo** certbot for certs

Test sites

- [https://hmsoftware.org/](https://hmsoftware.org/) - test site #1. Have used for Rails 
- [https://hmsoftware.uk/](https://hmsoftware.uk/)


Sites hosted elsewhere

- [https://hmsoftware.co.uk](https://hmsoftware.co.uk) - static site hosted on [netlify.com](https://www.netlify.com/) main company website which is being developed soon into a portfolio site
- [homebrewbeer.netlify.app](https://homebrewbeer.netlify.app/) - Hugo based static site on Netlify
- [https://davemateer.com/](https://davemateer.com/) - Jekyll blog on [pages.github.com/](https://pages.github.com/)


## VM Workers 

- General archiver eg [auto-archiver.com/](https://auto-archiver.com/) - Python which runs fine in 4GB RAM
- Tweet service that polls an Azure database every minute to see if any Tweets to send out. Python. 1GB RAM
- YouTube screenshotter archiver - I'm using [playwright.dev](https://playwright.dev/) via a Proxy [brightdata.com/](https://brightdata.com/) and using headful Firefox 

## Networking

Plusnet Two Router / DHCP is on [192.168.1.254](http://192.168.1.254/)

Proxmox is on a static IP allocation of [192.168.1.139](http://192.168.1.139:8006/) - port 8006 gives us the Proxmox web UI

pfSense VM has a DHCP (!fix this) alloction of [192.168.1.144](https://192.168.1.144:8080/) - port 8080 gives us the pfSense web UI

All port 80 and 443 traffic is routed to pfSense from the router.

## Power Costs

Big server may draw 300W at idle. eg dual xeon

My UK provider [good energy]() charges me 24.70 pence per kWh on 3rd Sept 2024. And 59.18 pence per day 

So the xeon server would cost 0.3 kW x 24 hours = 7.2 kWh/day = £1.78 / day
£53 / month

My 13th Gen Intel draws about 40W at idle running wifi, disks, etc..

### RGB Machine

40W at rest it draws = 0.04 kW * 24 hours = 0.96 kWh/day = £0.237 per day = £7 per month

## Hardware


## Storage in Proxmox - Nomenclature

**HERE**

I've been running for years with a single SSD for boot and Disk images. And a USB mounted ext4 external disk for backups.

Datacenter, Storage

ID, Type, Content

- local, Directory, "VZDump backup file, ISO image, Container Template"
- local-lvm, LVM-Thin, "Disk Image, Container"
- local-usb, Directory, "VZDump backup file, Disk Image"



## Storage

Drive Writes Per Day (DWPD) - how many times the entire capacity can be written per day over warrenty period. eg 1TB SSD DWPD rating of 1 - can write 1TB every day for 3 to 5 years.

SATA DOM (Disk on Module) - often used for boot drives.
SATA SSD - 2.5"
nvme 
Mechanical - for boot not recommended.. as SSD is cheaper, lower power and more reliable.

For boot drives approx 10 TB/year is a good number.. so shouldn't wear out the SSD at all.


So after my drive failure(s) of consumer ssd's, I want to make my server more resilient.

- m.2 2 * 1TB just for extra relaibility (check DWPD). He uses 2 x 256 AirDisk SSD
- SSD

Mirror the m.2 drives for the OS


 ## Logs

 Look for problems eg 

 ```bash
Sep 02 06:54:11 pve smartd[718]: Device: /dev/sda [SAT], SMART Usage Attribute: 190 Airflow_Temperature_Cel changed from 68 to 69
Sep 02 06:54:12 pve smartd[718]: Device: /dev/sdb [SAT], 8 Currently unreadable (pending) sectors
Sep 02 06:54:12 pve smartd[718]: Device: /dev/sdb [SAT], 8 Offline uncorrectable sectors
 ```

 My sdb is a mechanical disk I'm not using.


 ## Disks

<!-- [![alt text](/assets/2024-09-04/1.jpg "email"){:width="500px"}](/assets/2024-09-04/1.jpg) -->
[![alt text](/assets/2024-09-04/1.jpg "email")](/assets/2024-09-04/1.jpg)

Have got 26% wearout on this Samsung SSD 840 Pro. This is my backup server which I'm rebuilding soon.

This is nothing to worry about and drive shoudl still have plenty of life left.

## Mount USB Memeory Stick (backup)



## New Server Install - Prime


[https://www.proxmox.com/en/downloads](https://www.proxmox.com/en/downloads) Proxmox VE 8.2-2 - Aug 22nd 2024

[https://etcher.balena.io/](https://etcher.balena.io/) to flash a USB


My Black (and Silver) Proxmox servers are running under



---
layout: post
title: Promox 
description: 
menu: review
categories: Home 
published: true 
comments: false     
sitemap: false
image: /assets/2021-12-21/desk.jpg
---

<!-- [![alt text](/assets/2021-10-22/email-cover.jpg "email"){:width="800px"}](/assets/2021-10-22/email-cover.jpg) -->
<!-- [![alt text](/assets/2021-10-22/email-cover.jpg "Thanks to Solen Feyissa on unsplash - https://unsplash.com/@solenfeyissa")](https://unsplash.com/@solenfeyissa) -->


<!-- [![alt text](/assets/2021-12-21/desk.jpg "email")](/assets/2021-12-21/desk.jpg) -->

[Homelab Web Sever](/2022/01/12/home-web-server) is my previous article on setting up networking and a bare metal Ubuntu Server for hosting a website from my home.

In this article I am going to use virtualisation to let me run many virtual machines on the single bare metal server. To do this I am going to use:

[Promox VE - Virtual Environment](https://www.proxmox.com/en/proxmox-ve) is an open source server management platform for virtualisation which integrated the [KVM - Kernel Virtual Machine](https://www.linux-kvm.org/page/Main_Page) Hypervisor.

I could have used [VMWare ESXi](https://www.vmware.com/uk/products/esxi-and-esx.html)

## Why Run a Homelab?

I want to run

- Self hosted Wordpress for a low traffic site (Apache, PHP, MySQL)
- Python test environments to see what dependencies I need
- Potentially the home Plesk server
- Learn about Ansible

Other great ideas are: [https://github.com/awesome-selfhosted/awesome-selfhosted](https://github.com/awesome-selfhosted/awesome-selfhosted)

[https://www.reddit.com/r/selfhosted/](https://www.reddit.com/r/selfhosted/) 


I'm following along the excellent tutorials from which I'm updating (14th Jan 2022) [https://www.dlford.io/how-to-home-lab-part-1/](https://www.dlford.io/how-to-home-lab-part-1/)


## Install Promox
[https://www.proxmox.com/en/downloads/category/iso-images-pve](https://www.proxmox.com/en/downloads/category/iso-images-pve) Version: 7.1-2

I used [balenaEtcher](https://www.balena.io/etcher/) to create a boot USB.

### Network setup

FQDN: pve.dave.home

PVE is Promox Virtual Environment

My home subnet from DHCP on the router is: 192.168.1.0/24 ie subnet mask 255.255.255.0 ie 24 bits are used.

The DHCP range is 192.168.1.64 - 192.168.1.253

[![alt text](/assets/2022-01-13/static.jpg "static")](/assets/2022-01-13/static.jpg)

I've assigned pve to be on 192.168.1.139 and forced the DHCP table to not assign it to anything else.


## Web

[https://192.168.1.139:8006/](https://192.168.1.139:8006/)

u: root


```bash
cd /etc/apt/sources.list.d
mv pve-enterprise.list pve-enterprise.list.disabled
# careful of debian version
# Promox 7 (7th Dec 2021) runs on Bullseye (Debian 11.2, 18th Dec 2021)
echo 'deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription' > pve-community.list
# version 6
echo 'deb http://download.proxmox.com/debian/pve buster pve-no-subscription' > pve-community.list
apt update
apt -y dist-upgrade
```

- Promox 7 (7th Dec 2021) runs on Bullseye (Debian 11.2, 18th Dec 2021)
- Promox 6 runs on Buster (Debian 10)
- Promox 5 runs on Stretch (Debian 9 LTS until June 2022)

Proxmox version 5 instead of 6, change “buster” to “stretch” in line three. These are version names for Debian releases, Proxmox versions 5 and 6 run on Debian Stretch and Buster respectively.

## Secure Boot Problem

[![alt text](/assets/2022-01-13/boot.jpg "secure boot"){:width="500px"}](/assets/2022-01-13/boot.jpg)

After rebooting from updated above I got a Secure Boot Violation warning from my BIOS

The solution was to go into the BIOS - Boot, then change the order of the boot devices to be the M2 drive and not the UEFI boot loader device.

## Create a VM

[![alt text](/assets/2022-01-13/upload.jpg "upload")](/assets/2022-01-13/upload.jpg)

Upload ISO from workstation

Create VM:

- Name: webserver-test
- OS: Ubuntu (just uploaded)
- Disks: 32GB (Default)
- CPU: 1 Socket, 2 Cores
- Memory: 2048MB (Default)


[![alt text](/assets/2022-01-13/start.jpg "start")](/assets/2022-01-13/start.jpg)

Start it

[![alt text](/assets/2022-01-13/start.jpg "start")](/assets/2022-01-13/start.jpg)

It works! However

Got a DHCP address of: 192.168.1.140/24 which is an address gives from the routers DHCP server.

Something which is annoying here is I can't see the allocated DHCP address on this summary page. My routers summary page below is fickle too ie displays incomplete information


Ubuntu server install

- server name: webserver-test-ubuntu
- u: dave

put on SSH Server so I can connect from WSL2 on my workstation:

[![alt text](/assets/2022-01-13/ssh.jpg "ssh")](/assets/2022-01-13/ssh.jpg)

After the Ubuntu server installtion completes (a few minutes), and a reboot, I could access the VM

[![alt text](/assets/2022-01-13/wired.jpg "wired routes")](/assets/2022-01-13/wired routes.jpg)

Interesting information from my router, but not to be trusted. It does get confused. See below when I go to pfSense for DHCP and networking.

```bash
ssh 192.168.1.140
# internal DNS works as the router is handling it
ssh webserver-test-ubuntu
```

Can see the pve hypervisor on .139, and the newly created VM with it's correct linux servername I gave above when I named the server (not in pve).

```bash
sudo apt update -y
sudo apt upgrade -y

sudo apt-get install nginx -y
```

## Updates

For software updates maybe do every week.

[https://www.dlford.io/managing-proxmox-how-to-home-lab-part-2/#software-updates](https://www.dlford.io/managing-proxmox-how-to-home-lab-part-2/#software-updates)

For PVE version updates - follow the advice above. Maybe log into the server directly rather than the web interface.


## Snapshots VS Backups

Backups - complete representation of VM.

Snapshot - representation of VM's state.

Use a snapshot if you're doing a risky upgrade and may want to roll back a VM. Otherwise use a backup.

You can run a backup of a VM that is running.

[![alt text](/assets/2022-01-13/backup.jpg "backup")](/assets/2022-01-13/backup.jpg)

Took 1 minute (on SSD) at 2GB in disk space.


### Restore

Make sure the origianl VM is stopped. Then can restore it.

Restore from above took 7 minutes.


## Restore to a new VM

Loval (pve), Backups, Restore

[![alt text](/assets/2022-01-13/restorenew.jpg "restore new")](/assets/2022-01-13/restore new.jpg)

Check the Unique box to generate a new unique values eg MAC address

This took 32 seconds to create a new VM

The new VM started with the same name promox and the unix name was the same. Confusing.

[![alt text](/assets/2022-01-13/edit.jpg "edit")](/assets/2022-01-13/edit.jpg)

Rename VM in promox.

To change the hostname in Ubuntu:

```bash

# display current hostname
hostnamectl

# change hostname
sudo hostnamectl set-hostname newNameHere

# updates hosts file
sudo vim /etc/hosts

sudo reboot now
```

This works, but I'm sure there is a better way (Clone!) to easily spin up pre-built machine.

### Schedule backups

[![alt text](/assets/2022-01-13/backup2.jpg "backup2")](/assets/2022-01-13/backup2.jpg)

Selecting Schedule ~~2 am here~~ I have a typo, Schedule should be: 02:00 and VM's to backup. Next tab gives retention for days, weeks, months, years.


## Intranet Site with pfSense

[https://www.dlford.io/pfsense-nat-how-to-home-lab-part-3/](https://www.dlford.io/pfsense-nat-how-to-home-lab-part-3/) Infranet Site pfSense

[https://www.dlford.io/nginx-reverse-proxy-how-to-home-lab-part-4/](https://www.dlford.io/nginx-reverse-proxy-how-to-home-lab-part-4/) Nginx Reverse Proxy (also linked clone)

> Proxmox provides some really great firewall features, unfortunately they don’t offer the configuration options we need for DHCP, DNS, and NAT, so we’ll be using pfSense to handle all of those.

But do I need this firewall?

Ideally yes.. want the homelab to be as secure as possible.

He is heading towards the modem in bridge mode so pfSense gets a public IP from the ISP. Bridge mode disables firewalling on the modem.
Everything else is connected to the pfSense box cia a VLAN aware switch. Separate VLAN networks in pfSense for lab, IOT, workstations.


[https://www.pfsense.org/download/](https://www.pfsense.org/download/) AMD64 and ISO. I'm using pfsense 2.5.2

upload ISO to PME.


[![alt text](/assets/2022-01-13/net.jpg "network with default settings")](/assets/2022-01-13/net.jpg)

This was my System, Network with default settings before I changed anything.

We are going to create a private internal network

[![alt text](/assets/2022-01-13/bridge.jpg "bridge")](/assets/2022-01-13/bridge.jpg)

Setting up a linux bridge for private internal nework. 

Reboot promox after this.

[![alt text](/assets/2022-01-13/pf.jpg "pf")](/assets/2022-01-13/pf.jpg)

Advanced settings, start at boot. Start this first (higher number is later). Delay other VMs starting for 30s

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

OS to type Other.

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

Bus/Device to VirtIO Block and Discard ticked.

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

Cores 2 and CPU units: 2048. The higher the number so this will get more priority than a default 1024.

512MB Memory is fine.

[![alt text](/assets/2022-01-13/net2.jpg "network")](/assets/2022-01-13/net2.jpg)

Choose VirtIO for Model, and leave Bridge on old one. We will do once wizard is done.

[![alt text](/assets/2022-01-13/addnetwork.jpg "add network")](/assets/2022-01-13/addnetwork.jpg)

[![alt text](/assets/2022-01-13/mod.jpg "mod")](/assets/2022-01-13/mod.jpg)

I pressed No.

After booting:

- Should VLANS be set up now? No
- WAN interface: (vtnet0)
- LAN interface: (vtnet1)

[![alt text](/assets/2022-01-13/done.jpg "pfSense done")](/assets/2022-01-13/done.jpg)

8 to access a shell

```bash
# disable packet filter (firewall) temporarily so can access web interface from WAN side
pfctl -d
```

WAN IP is 192.168.1.144/24

LAN is 192.168.1.1/24 (ahh not good -conflicting)

I couldn't connect to the web interface from my workstation. Tried taking off the LAN network and just having the WAN on 192.168.1.144. I had to full reboot pfSense and then it worked!

[![alt text](/assets/2022-01-13/blanklan.jpg "blanklan")](/assets/2022-01-13/blanklan.jpg)

u: admin

p: pfsense

[![alt text](/assets/2022-01-13/general.jpg "general")](/assets/2022-01-13/general.jpg)

Domain: can use same as Promox host or a new one. I used `pve.dave.home` for Promox.

[![alt text](/assets/2022-01-13/wan.jpg "wan")](/assets/2022-01-13/wan.jpg)

I'm going to force pfSense to use 192.168.1.50 which is outside of the DHCP range of my router/modem.

[![alt text](/assets/2022-01-13/lan.jpg "lan")](/assets/2022-01-13/lan.jpg)

Lan on `172.16.44.1`

My plusnet router didn't like me assigning a static IP address when DHCP is turned on.

[![alt text](/assets/2022-01-13/static2.jpg "static2")](/assets/2022-01-13/static2.jpg)

The way to get it working was to allow pfSense to get a DHCP address from the router, then force the router's DHCP to always assign that IP address to pfSense (just like setting up PVE at the top of this article 1st screenshot)

Essentially I've 2 static IP's on my 'internal' network now:

- 192.168.1.139 - pve
- 192.168.1.144 - pfSense

In the screenshot I've logged in from my workstation which is on 192.168.1.105 which is assinged a DHCP address from the plusnet router.

### Firewall

Lets try and get access from my local network only to pfSense

[![alt text](/assets/2022-01-13/fire.jpg "fire")](/assets/2022-01-13/fire.jpg)

I was locked out after this change. I had to do `pfctl -d` again.

[![alt text](/assets/2022-01-13/fire2.jpg "fire2")](/assets/2022-01-13/fire2.jpg)

asdf

[![alt text](/assets/2022-01-13/fire2.jpg "fire2")](/assets/2022-01-13/fire2.jpg)

Interfaces > WAN, uncheck at bottom

`pfcrl -e` to enable the firewall

The firewall is enabled and we can now access the web interface from the workstation.


[![alt text](/assets/2022-01-13/fire8080.jpg "fire8080")](/assets/2022-01-13/fire8080.jpg)

Setting firewall port to 8080

## Template Server VM

qemu-guest-agent need to install this agent on all VM's running under promox

- Convert VM to Template

When clone the template to a new VM you get to skip all the confiuration

Another option is to

- Use a template without actuall converting it to a tempalte

Can't create a linked clone

But can make changes and install updates on teh template since clones aren't linked

### Linked Clones

Save disk space as base OS not copied to the clone



## Resources

[https://mtlynch.io/building-a-vm-homelab/](https://mtlynch.io/building-a-vm-homelab/) - he uses promox

[https://www.youtube.com/user/ProxmoxVE/videos](https://www.youtube.com/user/ProxmoxVE/videos) - PromoxVE YouTube

## Remote Admin

[https://tinypilotkvm.com/](https://tinypilotkvm.com/) looks very good. 
---
layout: post
title: Proxmox 
description: 
menu: review
categories: Home 
published: true 
comments: false     
sitemap: false
image: /assets/2021-12-21/desk.jpg
---

<!-- [![alt text](/assets/2021-10-22/email-cover.jpg "email"){:width="800px"}](/assets/2021-10-22/email-cover.jpg) -->
<!-- [![alt text](/assets/2021-10-22/email-cover.jpg "Thanks to Solen Feyissa on unsplash - https://unsplash.com/@solenfeyissa")](https://unsplash.com/@solenfeyissa) -->


<!-- [![alt text](/assets/2021-12-21/desk.jpg "email")](/assets/2021-12-21/desk.jpg) -->

[Homelab Web Sever](/2022/01/12/home-web-server) is my previous article on setting up networking and a bare metal Ubuntu Server for hosting a website from my home.

In this article I am going to use virtualisation to let me run many virtual machines on the single bare metal server. To do this I am going to use:

[Proxmox VE - Virtual Environment](https://www.proxmox.com/en/proxmox-ve) is an open source server management platform for virtualisation which integrates the [KVM - Kernel Virtual Machine](https://www.linux-kvm.org/page/Main_Page) Hypervisor.

[VMWare ESXi](https://www.vmware.com/uk/products/esxi-and-esx.html) is an alternative to Proxmox VE

## Why Run a Homelab?

I want to run

- Self hosted Wordpress for a low traffic site (Apache, PHP, MySQL)
- Python test environments to see what dependencies I need
- Potentially the home Plesk server
- Learn about Ansible

[https://github.com/awesome-selfhosted/awesome-selfhosted](https://github.com/awesome-selfhosted/awesome-selfhosted) - other great ideas for home server projects

[https://www.reddit.com/r/selfhosted/](https://www.reddit.com/r/selfhosted/) - discussion on home server / self hosted

## Install Proxmox - Part 1

I'm following along the excellent tutorials from which I'm updating (14th Jan 2022) [https://www.dlford.io/how-to-home-lab-part-1/](https://www.dlford.io/how-to-home-lab-part-1/)

[https://www.proxmox.com/en/downloads/category/iso-images-pve](https://www.proxmox.com/en/downloads/category/iso-images-pve) Version: 7.1-2

I used [balenaEtcher](https://www.balena.io/etcher/) to create a boot USB.

## Network setup

FQDN: `pve.dave.home`

[https://news.ycombinator.com/item?id=29917860](https://news.ycombinator.com/item?id=29917860) according to this a better name may be `pve.home.arpa`. Or just register a real domain name to make sure it wont conflict.

PVE is Proxmox Virtual Environment

My home subnet from DHCP on the router is: `192.168.1.0/24` ie subnet mask `255.255.255.0` ie 24 bits are used.

The DHCP range is `192.168.1.64 - 192.168.1.253`

[![alt text](/assets/2022-01-13/static.jpg "static")](/assets/2022-01-13/static.jpg)

I've assigned pve to be on 192.168.1.139 and forced the DHCP table to not assign it to anything else - it is a static IP address now.

## Web

[https://192.168.1.139:8006/](https://192.168.1.139:8006/) - PVE Web interface

u: root

Here we are setting up the updates for PVE:

```bash
cd /etc/apt/sources.list.d
mv pve-enterprise.list pve-enterprise.list.disabled
# careful of debian version
# Proxmox 7 (7th Dec 2021) runs on Bullseye (Debian 11.2, 18th Dec 2021)
echo 'deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription' > pve-community.list
# version 6
echo 'deb http://download.proxmox.com/debian/pve buster pve-no-subscription' > pve-community.list
apt update
apt -y dist-upgrade
```

- Proxmox 7 (7th Dec 2021) runs on Bullseye (Debian 11.2, 18th Dec 2021)
- Proxmox 6 runs on Buster (Debian 10)
- Proxmox 5 runs on Stretch (Debian 9 LTS until June 2022)

Proxmox version 5 instead of 6, change “buster” to “stretch” in line three. These are version names for Debian releases, Proxmox versions 5 and 6 run on Debian Stretch and Buster respectively.

## Secure Boot Problem

[![alt text](/assets/2022-01-13/boot.jpg "secure boot"){:width="500px"}](/assets/2022-01-13/boot.jpg)

After rebooting from updated above I got a Secure Boot Violation warning from my BIOS

The solution was to go into the BIOS - Boot, then change the order of the boot devices to be the M2 drive and not the UEFI boot loader device.

## Create a VM

[![alt text](/assets/2022-01-13/upload.jpg "upload")](/assets/2022-01-13/upload.jpg)

Upload ISO from workstation

Create VM:

- Name: webserver-test
- OS: Ubuntu (just uploaded)
- Disks: 32GB (Default)
- CPU: 1 Socket, 2 Cores
- Memory: 2048MB (Default)


[![alt text](/assets/2022-01-13/start.jpg "start")](/assets/2022-01-13/start.jpg)

Start it

[![alt text](/assets/2022-01-13/start.jpg "start")](/assets/2022-01-13/start.jpg)

It works! However

Got a DHCP address of: 192.168.1.140/24 which is an address gives from the routers DHCP server.

Something which is annoying here is I can't see the allocated DHCP address on this summary page. I need a guest agent installed - see below `qemu-guest-agent`

My routers summary page below is fickle too ie displays incomplete information


Ubuntu server install

- server name: webserver-test-ubuntu
- u: dave

put on SSH Server so I can connect from WSL2 on my workstation:

[![alt text](/assets/2022-01-13/ssh.jpg "ssh")](/assets/2022-01-13/ssh.jpg)

After the Ubuntu server installtion completes (a few minutes), and a reboot, I could access the VM

[![alt text](/assets/2022-01-13/wired.jpg "wired routes")](/assets/2022-01-13/wired routes.jpg)

Interesting information from my router, but not to be trusted. It does get confused. See below when I go to pfSense for DHCP and networking.

```bash
ssh 192.168.1.140
# internal DNS works as the router is handling it
ssh webserver-test-ubuntu
```

Can see the pve hypervisor on .139, and the newly created VM with it's correct linux servername I gave above when I named the server (not in pve).

```bash
sudo apt update -y
sudo apt dist-upgrade -y

sudo apt-get install nginx -y
```

## Updates - Part 2

[https://www.dlford.io/managing-proxmox-how-to-home-lab-part-2/#software-updates](https://www.dlford.io/managing-proxmox-how-to-home-lab-part-2/#software-updates)

For software updates maybe do every week.

For PVE version updates - follow the advice above. Maybe log into the server directly rather than the web interface.

[![alt text](/assets/2022-01-13/update.jpg "update pve")](/assets/2022-01-13/update.jpg)

Reboot PVE if Kernel update.

After a full shutdown and restart the following day, pfSense did not auto start up. I tried to replicate but perhaps after a proxmox update it needs a full shutdown / startup test.

```bash
# stay on top of VM updates
sudo apt update
sudo apt dist-upgrade 
```

[![alt text](/assets/2022-01-13/distup.jpg "dist upgrade")](/assets/2022-01-13/distup.jpg)

Upgrading the distribution of a linked clone - lets find out how this affects new instances of a linked clone.

## Snapshots VS Backups

Backups - complete representation of VM.

Snapshot - representation of VM's state.

Use a snapshot if you're doing a risky upgrade and may want to roll back a VM. Otherwise use a backup.

You can run a backup of a VM that is running.

[![alt text](/assets/2022-01-13/backup.jpg "backup")](/assets/2022-01-13/backup.jpg)

Took 1 minute (on SSD) at 2GB in disk space.

### Restore

Make sure the origianl VM is stopped. Then can restore it.

Restore from above took 7 minutes.

## Restore to a new VM

Local (pve) > Backups > Restore

[![alt text](/assets/2022-01-13/restorenew.jpg "restore new")](/assets/2022-01-13/restore new.jpg)

Check the Unique box to generate a new unique values eg MAC address

This took 32 seconds to create a new VM

The new VM started with the same name Proxmox and the unix name was the same. Confusing.

[![alt text](/assets/2022-01-13/edit.jpg "edit")](/assets/2022-01-13/edit.jpg)

Rename VM in Proxmox.

To change the hostname in Ubuntu:

```bash

# display current hostname
hostnamectl

# change hostname
sudo hostnamectl set-hostname newNameHere

# updates hosts file
sudo vim /etc/hosts

sudo reboot now
```

This works, but I'm sure there is a better way (Linked Clone) to easily spin up pre-built machine.

### Schedule backups

[![alt text](/assets/2022-01-13/backup2.jpg "backup2")](/assets/2022-01-13/backup2.jpg)

Selecting Schedule ~~2 am here~~ I have a typo, Schedule should be: 02:00 and VM's to backup. Next tab gives retention for days, weeks, months, years.

## Intranet Site with pfSense - Part 3

[https://www.dlford.io/pfsense-nat-how-to-home-lab-part-3/](https://www.dlford.io/pfsense-nat-how-to-home-lab-part-3/) Intranet Site pfSense

> Proxmox provides some really great firewall features, unfortunately they don’t offer the configuration options we need for DHCP, DNS, and NAT, so we’ll be using pfSense to handle all of those.

But do I need this firewall if I want to host some websites?

Yes.. want the homelab to be as secure as possible. The firewall allows me to segreate my home network from the 'prod' which is called 'LAN' network.

**TODO** put in network diagram here

He is heading towards the modem in bridge mode so pfSense gets a public IP from the ISP. Bridge mode disables firewalling on the modem. I'm still using my modems firewall and port forwarding 80 and 443 to the firewall.

Everything else is connected to the pfSense box cia a VLAN aware switch. Separate VLAN networks in pfSense for lab, IOT, workstations.

[https://www.pfsense.org/download/](https://www.pfsense.org/download/) AMD64 and ISO. I'm using pfsense 2.5.2

upload ISO to PME.

[![alt text](/assets/2022-01-13/net.jpg "network with default settings")](/assets/2022-01-13/net.jpg)

This was my System, Network with default settings before I changed anything.

We are going to create a private internal network

[![alt text](/assets/2022-01-13/bridge.jpg "bridge")](/assets/2022-01-13/bridge.jpg)

Setting up a linux bridge for private internal nework (LAN) whgich is on `172.16.44.0`

Reboot Proxmox after this.

[![alt text](/assets/2022-01-13/pf.jpg "pf")](/assets/2022-01-13/pf.jpg)

Advanced settings, start at boot. Start this first (higher number is later). Delay other VMs starting for 30s

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

OS to type Other.

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

Bus/Device to VirtIO Block and Discard ticked.

[![alt text](/assets/2022-01-13/os.jpg "os")](/assets/2022-01-13/os.jpg)

Cores 2 and CPU units: 2048. The higher the number so this will get more priority than a default 1024.

512MB Memory is fine.

[![alt text](/assets/2022-01-13/net2.jpg "network")](/assets/2022-01-13/net2.jpg)

Choose VirtIO for Model, and leave Bridge on old one. We will do once wizard is done.

[![alt text](/assets/2022-01-13/addnetwork.jpg "add network")](/assets/2022-01-13/addnetwork.jpg)

[![alt text](/assets/2022-01-13/mod.jpg "mod")](/assets/2022-01-13/mod.jpg)

I pressed No.

After booting:

- Should VLANS be set up now? No
- WAN interface: (vtnet0)
- LAN interface: (vtnet1)

[![alt text](/assets/2022-01-13/done.jpg "pfSense done")](/assets/2022-01-13/done.jpg)

8 to access a shell

```bash
# disable packet filter (firewall) temporarily so can access web interface from WAN side
pfctl -d
```

WAN IP is 192.168.1.144/24

LAN is 192.168.1.1/24 (ahh not good -conflicting)

I couldn't connect to the web interface from my workstation. Tried taking off the LAN network and just having the WAN on 192.168.1.144. I had to full reboot pfSense and then it worked!

[![alt text](/assets/2022-01-13/blanklan.jpg "blanklan")](/assets/2022-01-13/blanklan.jpg)

u: admin

p: pfsense

[![alt text](/assets/2022-01-13/general.jpg "general")](/assets/2022-01-13/general.jpg)

Domain: can use same as Proxmox host or a new one. I used `pve.dave.home` for Proxmox. [https://news.ycombinator.com/item?id=29917860](https://news.ycombinator.com/item?id=29917860) discussion here on a better name.

[![alt text](/assets/2022-01-13/wan.jpg "wan")](/assets/2022-01-13/wan.jpg)

I'm going to force pfSense to use 192.168.1.50 which is outside of the DHCP range of my router/modem.

[![alt text](/assets/2022-01-13/lan.jpg "lan")](/assets/2022-01-13/lan.jpg)

Lan on `172.16.44.1`

My plusnet router didn't like me assigning a static IP address when DHCP is turned on.

[![alt text](/assets/2022-01-13/static2.jpg "static2")](/assets/2022-01-13/static2.jpg)

The way to get it working was to allow pfSense to get a DHCP address from the router, then force the router's DHCP to always assign that IP address to pfSense (just like setting up PVE at the top of this article 1st screenshot)

Essentially I've 2 static IP's on my 'internal' network now:

- 192.168.1.139 - pve
- 192.168.1.144 - pfSense

In the screenshot I've logged in from my workstation which is on 192.168.1.105 which is assinged a DHCP address from the plusnet router. I've since made that a static IP on the modem.

## Firewall

Lets try and get access from my local network only to pfSense

[![alt text](/assets/2022-01-13/fire.jpg "fire")](/assets/2022-01-13/fire.jpg)

I was locked out after this change. I had to do `pfctl -d` again.

[![alt text](/assets/2022-01-13/fire2.jpg "fire2")](/assets/2022-01-13/fire2.jpg)

then 

[![alt text](/assets/2022-01-13/fire2.jpg "fire2")](/assets/2022-01-13/fire2.jpg)

Interfaces > WAN, uncheck at bottom

`pfcrl -e` to enable the firewall

The firewall is enabled and we can now access the web interface from the workstation.

[![alt text](/assets/2022-01-13/fire8080.jpg "fire8080")](/assets/2022-01-13/fire8080.jpg)

Setting firewall port to 8080

## Template Server VM

`qemu-guest-agent` need to install this agent on all VM's running under Proxmox

- Convert VM to Template

When clone the template to a new VM you get to skip all the confiuration

Another option is to

- Use a template without actuall converting it to a tempalte

Can't create a linked clone

But can make changes and install updates on teh template since clones aren't linked

### Linked Clones

Save disk space as base OS not copied to the clone

To create a linked clone:

Create VM

- General
	-	VM ID: 1001 (keep templates at the bottom  of the VM list)
	- Name: Ubuntu-20.03.3-20220117
- Disk:
  - 8GB
	- Discard checked (will free up space from files deleted on vm)
- CPU:
   - Cores: 2
- Memory:
   - 512MB
- Network:
	 - Bridge: vmbr1 (the private VM internal server network)

Start the VM

[![alt text](/assets/2022-01-13/error.jpg "error")](/assets/2022-01-13/error.jpg)

Hmm - didn't work! Try giving it 1GB of RAM. Yes this worked - using 879MB during install.


[![alt text](/assets/2022-01-13/dhcp.jpg "dhcp")](/assets/2022-01-13/dhcp.jpg)

Next thing is my internal network isn't working ie not getting assigned a DHCP address.

[![alt text](/assets/2022-01-13/lan2.jpg "lan2")](/assets/2022-01-13/lan2.jpg)

So this worked and I've got an internal address now. I updated the installer

Install the OS
 - Use an entire disk and set up LVM

machine name: red

user: dave

password:

Didn't install SSH as I usually do

Proxmox: Hardware, CD/DVD, Do not use media

Then press enter in ubuntu console as have removed installation hardware.

```bash
sudo apt update
# Apt-get dist-upgrade has a smart conflict resolution system, so it will attempt to upgrade the most important packages, at the expense of those deemed less important
sudo apt dist-upgrade

# helps the Proxmox host communicate with the VM guest 
sudo apt install -y qemu-guest-agent
```

[dist-upgrade link](https://www.techrepublic.com/article/how-to-tell-the-difference-between-apt-get-upgrade-apt-get-dist-upgrade-and-do-release-upgrade/#:~:text=Apt%2Dget%20dist%2Dupgrade%20has,remove%20packages%2C%20it%20only%20upgrades.)


Agent:

- shutdown command on Proxmox itself will result in cleaner shutdown on the vm

Shutdown the VM

[![alt text](/assets/2022-01-13/agent.jpg "agent")](/assets/2022-01-13/agent.jpg)

Tick both boxes.

Click on name on VM, Convery to Template

## Create Web Server VM

Right click on template VM and Clone, Linked Clone.

[![alt text](/assets/2022-01-13/clink.jpg "create linked clone")](/assets/2022-01-13/clink.jpg)

[![alt text](/assets/2022-01-13/option3.jpg "options")](/assets/2022-01-13/options3.jpg)

Options > Start at boot yes, Start/Shutdown order: 20 (so will start after pfSense)

Hardware, Network. Copy MAC Address - need it later to set up a DHCP reservation.

start the VM

[![alt text](/assets/2022-01-13/nginx.jpg "nginx")](/assets/2022-01-13/nginx.jpg)

The agent is working as I can see a good LAN address! We will change this below to be a static IP reservation.

## Boilerplate

Anytime you clone a VM, run the following commands to ensure uniqueness:

So this was tricky as couldn't copy and paste. I ended up doing a Firewall > NAT > Port Forward on pfSense port 22 to the newly created VM so could use SSH.


```bash
# to get paste use SSH from workstation
sudo apt install ssh-server

# to run sudo as interactive sessio
sudo -i

rm -f /var/lib/dbus/machine-id
rm -f /etc/machine-id
dbus-uuidgen --ensure=/etc/machine-id
ln -s /etc/machine-id /var/lib/dbus/

ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa -y
ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa -y
ssh-keygen -f /etc/ssh/ssh_host_ecdsa_key -N '' -t ecdsa -b 521 -y

sudo touch /etc/cloud/cloud-init.disabled

# red was the name of my template vm
sed -i 's/red/nginx/g' /etc/hosts
sed -i 's/red/nginx/g' /etc/hostname

# set new hostname to nginx
hostnamectl set-hostname nginx

# reboot
sudo apt install nginx
```

Hmm but I can't get to `ssh 172.16.44.10` from my workstation. Interestingly my WSL2 is on `172.29.188.33/20` - this is not conflicting.

after a reboot I got `172.16.44.11`

## DHCP Reservation

[![alt text](/assets/2022-01-13/nginx2.jpg "nginx2")](/assets/2022-01-13/nginx2.jpg)

pfsense, Services, DHCP Server, Edit Static mapping (at bottom)

Reserving `172.16.44.101` for this mac address on ie the nginx server.


## Create Port Forward

[![alt text](/assets/2022-01-13/ipalias.jpg "ipalias")](/assets/2022-01-13/ipalias.jpg)

Firewall - Aliases - Add IP


[![alt text](/assets/2022-01-13/ports2.jpg "ports2")](/assets/2022-01-13/ports2.jpg)

Firewall - Aliases - Ports

Firewall > NAT > Port Forward


[![alt text](/assets/2022-01-13/webports.jpg "web ports")](/assets/2022-01-13/webports.jpg)

Then reboot NGINX VM.

Check IP Address is `172.16.44.101`

Check if `http://192.168.1.144/` which is the IP address of pfSense works after a few minutes. It did.

My workstation is `192.168.1.105`

Backup the VM so can restore.


## Serve an App on NGINX

[![alt text](/assets/2022-01-13/webports.jpg "web ports")](/assets/2022-01-13/webports.jpg)

Forwading SSH so could use copy and paste!

[https://linuxize.com/post/how-to-set-up-nginx-server-blocks-on-ubuntu-20-04/](https://linuxize.com/post/how-to-set-up-nginx-server-blocks-on-ubuntu-20-04/)

```bash
sudo -i
apt install git
cd /var/www
rm -rf html
git clone https://github.com/ondras/my-mind.git html

chown -R www-data: /var/www/html

# set directories
find /var/www/html/ -type d -exec chmod 755 {} \;
find /var/www/html/ -type f -exec chmod 644 {} \;
```

## Setup NGINX Reverse Proxy - Part 4

[https://www.dlford.io/nginx-reverse-proxy-how-to-home-lab-part-4/](https://www.dlford.io/nginx-reverse-proxy-how-to-home-lab-part-4/)

Growing disk 

He uses the hosts file on workstation to get to the newly created site - not good.

## Secure SSH Remote Access - Part 5

[https://www.dlford.io/secure-ssh-access-how-to-home-lab-part-5/](https://www.dlford.io/secure-ssh-access-how-to-home-lab-part-5/)

Createa a new VM - ap for access point.

Fail2Ban - looks useful.

## Hosting on the Web - Part 6

[https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/](https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/)

[![alt text](/assets/2022-01-13/nonpublic.jpg "non public")](/assets/2022-01-13/nonpublic.jpg)

Firewall > Alias

[![alt text](/assets/2022-01-13/lanallow.jpg "lanallow")](/assets/2022-01-13/lanallow.jpg)

Firewall > Rules > LAN

Allow all ports from Non_Public - all this is doing is allowing all ports between machines on the pfSense LAN. Currently I've only got 1 machine (nginx), but maybe I'll have a reverse proxy soon.

[![alt text](/assets/2022-01-13/dns.jpg "dns")](/assets/2022-01-13/dns.jpg)

Allow outbound DNS


[![alt text](/assets/2022-01-13/nonpub2.jpg "nonpub2")](/assets/2022-01-13/nonpub2.jpg)

Reject Non_Public

Can't go from LAN to any other machine on Non_Public ie can't get to other machines on LAN or my workstation. ie this is to protect my home network.

I had issues with outbound requests going from nginx server to outside world, so deleted subnets here except `192.168.0.0` which is fine for me.

[![alt text](/assets/2022-01-13/allowicmp.jpg "allowicmp")](/assets/2022-01-13/allowicmp.jpg)

Allow ICMP from LAN outbound


[![alt text](/assets/2022-01-13/allowweb.jpg "allowweb")](/assets/2022-01-13/allowweb.jpg)
Allow Web from LAN outbound

[![alt text](/assets/2022-01-13/allowweb.jpg "allowweb")](/assets/2022-01-13/allowweb.jpg)

Order and delete the final 2 rules.


## Settings

System > Advanced > Networking

Allow IPv6 - uncheck

System > Advanced > Admin Access

Anti-lockout - uncheck


## Add Port Forward from the Outside World


Get Nginx listening on 443

```bash
cd /etc/nginx/sites-available

sudo apt install ssl-cert

#sudo make-ssl-cert generate-default-snakeoil

# uncomment listen on 443
# uncomment snakeoil.conf
sudo vim default

sudo nginx -s reload

## comment back in the 443

```

I had a problem that I couldn't reach apt update server from nginx `172.16.44.101` ie probable firewall rule?

@Yes it was a problem with the deny rule.

Let's get SSL working on the local machine first:

[https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-20-04-1](https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-20-04-1)

Use a self signed cert.

[https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/#reconfigure-nginx](https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/#reconfigure-nginx) - I'm not using his instructions - the digital ocean ones are slightly different.

```bash
sudo -i
cd ~

# I took just defaults as don't care - we'll setup up proper cert later
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt

# this tooks 10 minutes
sudo openssl dhparam -out /etc/nginx/dhparam.pem 4096

# create new file
sudo vim /etc/nginx/snippets/self-signed.conf

# contents of above file
ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;


# create new file
vim /etc/nginx/snippets/ssl-params.conf

```
I used this ssl-params.conf

```bash
ssl_protocols TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_dhparam /etc/nginx/dhparam.pem;
ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
ssl_ecdh_curve secp384r1;
ssl_session_timeout  10m;
ssl_session_cache shared:SSL:10m;
ssl_session_tickets off;
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;
# Disable strict transport security for now. You can uncomment the following
# line if you understand the implications.
#add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";

```

then

```bash
# interesting sites-enabled is just a sym link 
vim /etc/nginx/sites-available/default


server {
        listen 443 ssl;
        listen [::]:443 ssl;
        include snippets/self-signed.conf;
        include snippets/ssl-params.conf;

        root /var/www/htmldm;
        index index.html index.htm index.nginx-debian.html;

        server_name your_domain.com www.your_domain.com;

        location / {
                try_files $uri $uri/ =404;
        }

}

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/htmldm;

        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
}

```

then

```bash
# check firewall
ufw status

# test config
sudo nginx -t

sudo systemctl restart nginx

# works
curl http://localhost

# get a cert error 
curl https://localhost
```

Then try from workstation and it works!

[![alt text](/assets/2022-01-13/routerports.jpg "routerports")](/assets/2022-01-13/routerports.jpg)

Now lets open up ports on my router to pfSense.

[![alt text](/assets/2022-01-13/youget.jpg "youget")](/assets/2022-01-13/youget.jpg)


[https://www.yougetsignal.com/tools/open-ports/](https://www.yougetsignal.com/tools/open-ports/) use this tool to see what open ports I have.


I've got Dynamic DNS running from the router on `mateer.hopto.org`

Then trying a real domain (which used to point to `hmsoftwareuk.netlify.app`)

`hmsoftware.uk` should now alias to `mateer.hopto.org`

It works fine. Interestinly only Firefox allows me to see the invalid self signed cert, as I'm using HSTS.


[![alt text](/assets/2022-01-13/hw.jpg "hw")](/assets/2022-01-13/hw.jpg)


## Apex Domains

[https://www.yes-www.org/](https://www.yes-www.org/) he argues to keep the www. whereas I've gone the other way. Google goes to www. as does the BBC


## LetsEncrypt

see [https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/#letsencrypt](https://www.dlford.io/hosting-on-the-web-how-to-home-lab-part-6/#letsencrypt)



## Logging - Part 7

[https://www.dlford.io/log-management-how-to-home-lab-part-7/](https://www.dlford.io/log-management-how-to-home-lab-part-7/)

Graylog

## Docker - Part 8

[https://www.dlford.io/docker-basics-how-to-home-lab-part-8/](https://www.dlford.io/docker-basics-how-to-home-lab-part-8/)

## 

## VLANs - Part 9

[https://www.dlford.io/expanding-your-home-network-how-to-home-lab-part-9/](https://www.dlford.io/expanding-your-home-network-how-to-home-lab-part-9/)

## Resources

[https://forum.proxmox.com/](https://forum.proxmox.com/)

[https://www.reddit.com/r/Proxmox/](https://www.reddit.com/r/Proxmox/)

[https://mtlynch.io/building-a-vm-homelab/](https://mtlynch.io/building-a-vm-homelab/) - he uses Proxmox

[https://www.youtube.com/user/ProxmoxVE/videos](https://www.youtube.com/user/ProxmoxVE/videos) - ProxmoxVE YouTube

[Mastering Proxmox book](https://www.amazon.co.uk/Mastering-Proxmox-virtualized-environments-hypervisor-ebook/dp/B075DBHJ8T/ref=sr_1_1)

## Remote Admin

[https://tinypilotkvm.com/](https://tinypilotkvm.com/) looks very good. 
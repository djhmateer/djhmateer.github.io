---
layout: post
title:  Calling Azure from C# wih Azure SDKs and Bash
description: 
menu: review
categories: Azure 
published: true 
comments: false     
sitemap: false
image: /assets/2020-02-03/40.jpg
---

<!-- [![Bitcoin logo](/assets/2021-02-19/bitcoin.svg "Bitcoin"){:width="500px"}](/assets/2021-02-19/bitcoin.svg) -->

I've used the AZ CLI for many years. Now I've got a C# project where I need to spin up a Virtual Machine in Azure, so need to control Azure with the SDK

## Azure SDK for .NET Preview (2020)
[https://devblogs.microsoft.com/azure-sdk/introducing-new-previews-for-azure-management-libraries/](https://devblogs.microsoft.com/azure-sdk/introducing-new-previews-for-azure-management-libraries/) Introducing new previews for Azure Management Libraries


[https://github.com/Azure/azure-sdk-for-net/blob/master/doc/mgmt_preview_quickstart.md](https://github.com/Azure/azure-sdk-for-net/blob/master/doc/mgmt_preview_quickstart.md) quickstart 


`Azure.Core` - correct new namespace which uses async. 

[https://docs.microsoft.com/en-gb/samples/azure-samples/azure-samples-net-management/compute-create-vm/](https://docs.microsoft.com/en-gb/samples/azure-samples/azure-samples-net-management/compute-create-vm/) good samples.tutorial (with bits that don't work in preview2)


## Azure SDK

Namespaces like

`Microsoft.Azure.Management.Fluent`


[https://docs.microsoft.com/en-gb/dotnet/azure/sdk/authentication](https://docs.microsoft.com/en-gb/dotnet/azure/sdk/authentication)

`Azure.Identity`


https://docs.microsoft.com/en-us/dotnet/api/overview/azure/virtualmachines
https://github.com/Azure/azure-libraries-for-net#ready-to-run-code-samples-for-virtual-machines

## Authentication File

[https://github.com/Azure/azure-libraries-for-net/blob/master/AUTH.md](https://github.com/Azure/azure-libraries-for-net/blob/master/AUTH.md) following these good instructions

```bash

# make sure you're logged in as the correct user
az account show

# get details of the subscription for logged in account
# interestingly it shows 2 subscriptions for my dave@hmsoftware.co.uk account which is wrong
az account list

# set the subscription just to make sure
az account set --subscription 'Azure subscription 1'

# need to be 
az ad sp create-for-rbac --sdk-auth > my.azureauth
```

[https://docs.microsoft.com/en-gb/cli/azure/create-an-azure-service-principal-azure-cli](https://docs.microsoft.com/en-gb/cli/azure/create-an-azure-service-principal-azure-cli) creating an Azure Service Principle with the Azure CLI

## Demo Code

[https://github.com/Azure-Samples/compute-dotnet-create-virtual-machines-from-generalized-image-or-specialized-vhd](https://github.com/Azure-Samples/compute-dotnet-create-virtual-machines-from-generalized-image-or-specialized-vhd)

Need to set AZURE_AUTH_LOCATION environment variable to the full path location of `my.azureauth`

`Microsoft.Azure.Management.Fluent` import from NuGet 

**HERE** look for AzureSDKConsole in test code folder
  I couldn't get cloud-init to work properly
  was complaining about no python on 20_04-lts

Also code was messy. Azure CLI much nicer


## Bash - Azure CLI


[https://jackma.com/2019/04/20/execute-a-bash-script-via-c-net-core/](https://jackma.com/2019/04/20/execute-a-bash-script-via-c-net-core/)

**HERE** - look for test project BashTest

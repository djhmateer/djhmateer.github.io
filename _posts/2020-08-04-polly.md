---
layout: post
title: Polly 
description: 
menu: review
categories: Functional C# BrokenLinkChecker
published: false 
comments: false     
sitemap: false
image: /assets/2020-07-22/donut.jpg
---

[![alt text](/assets/2020-07-26/night.jpg "Photo by @micahtindell from Unsplash"){:width="600px"}](https://unsplash.com/@micahtindell)

I'm [writing articles](/#BrokenLinkChecker) on developing a website broken link checker in C#. This is part of that series.

There is a [intro article on how I used Dapper](/2020/07/22/donut-functions-in-csharp)

In my broken link checker I'm using SQL Azure, which very infrequently will not work, so I needed some kind of retry mechanism in my SQL calls. I reached out to the excellent Polly library.

I'm also doing a lot of Http calls in my broken link checker, so have explored how polly could help too.

## SQL

[Polly](https://github.com/App-vNext/Polly)

[https://hyr.mn/dapper-and-polly/](https://hyr.mn/dapper-and-polly) has a good tutorial where he uses an extension method.

```cs
public static async Task<IEnumerable<Actor>> GetTop10ActorsWithRetry(string connectionString)
    => await WithConnection(connectionString, async x =>
    {
        // Using an extension method to call the polly retry code
        var result = await x.QueryAsyncWithRetry<Actor>(
            @"SELECT TOP 10 *
            FROM Actors");
        return result;
    });
```

We can make the code more terse using our wrapper function. This means we don't need the extension methods.

```cs
public static async Task<T> WithConnection<T>(
    string connectionString,
    Func<IDbConnection, Task<T>> func)
{
    await using var conn = new SqlConnection(connectionString);
    //return await func(conn);
    return await DapperExtensions.RetryPolicy.ExecuteAsync(() => func(conn));
}
```

## Testing it works

[Polly-Samples](https://github.com/App-vNext/Polly-Samples)


## Http testing


